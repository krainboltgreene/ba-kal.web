<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ba Kom</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script>

    </script>
  </head>

  <body>

    <main class="container-fluid">
      <section class="alert alert-light mb-0">
        Booting up...
      </section>
    </main>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pouchdb/7.0.0/pouchdb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb-quick-search@1.3.0/dist/pouchdb.quick-search.min.js" integrity="sha256-O2Fg8+71Ghtl5GSB/Z4ielEWXj46b163E3fcdFsc8lE=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ramda/0.25.0/ramda.min.js"></script>

    <script type="text/javascript">
      const DATABASE = new PouchDB("local");

      const REPLICATION = DATABASE.replicate.from("http://35.224.124.140:5984/dictionary", {live: true, retry: true, heartbeat: true});
    </script>

    <script type="text/javascript">
      function ResultHeader ({word, documentLoaded}) {
        return React.createElement(
          "header",
          {className: "d-flex w-100 justify-content-between"},
          [
            React.createElement(
              "h5",
              {key: "result-header-word", className: "mb-1"},
              word
            ),
            React.createElement(
              "small",
              {key: "result-header-loaded", className: "text-muted"},
              `Last fetched ${moment(documentLoaded).fromNow()}`
            )
          ]
        )
      }

      function ResultFooter ({id, score}) {
        return React.createElement(
          "footer",
          {className: "d-flex w-100 justify-content-between"},
          [
            React.createElement(
              "a",
              {key: "result-footer-edit", className: "text-muted"},
              "edit"
            ),
            React.createElement(
              "small",
              {key: "result-footer-score", className: "text-muted"},
              score
            )
          ]
        )
      }

      function ResultRoot ({rootLoaded, total_rows, rows}) {
        if (rootLoaded) {
          return React.createElement(
            "section",
            {},
            rows.map(function ({id, highlighting: {word}}) {
              return React.createElement("li", {key: `result-root-${id}`, className: "badge badge-pill badge-light", dangerouslySetInnerHTML: {__html: word}, id})
            })
          )
        };

        return React.createElement(
          "section",
          {className: "alert alert-warning mb-0"},
          "Searching for root words..."
        );
      }

      function Result ({id, score}) {
        const [documentLoaded, setDocumentLoaded] = React.useState(false);
        const [rootLoaded, setRootLoaded] = React.useState(false);
        const [{word, definitions}, setDocumentResult] = React.useState({});
        const [rootResults, setRootResults] = React.useState({});

        React.useEffect(function () {
          DATABASE
            .get(id)
            .then(setDocumentResult)
            .then(() => setDocumentLoaded(new Date()));
        }, [id, score]);

        React.useEffect(function () {
          if (word) {
            Promise.all(
              word
                .split(" / ")
                .flatMap((subsection) => subsection.split(" "))
                .map((subword) => DATABASE.search({query: subword, fields: ["word"], highlighting: true, highlighting_pre: "<strong class=\"text-info\">"}))
            )
              .then(
                (results) =>
                  results.reduce(
                    (accumulation, result) =>
                      ({total_rows: accumulation.total_rows + result.total_rows, rows: [...accumulation.rows, ...result.rows]})
                  )
              )
              .then((results) => ({...results, rows: R.uniqBy(({id}) => id, results.rows)}))
              .then(setRootResults)
              .then(() => setRootLoaded(new Date()));
          }

        }, [documentLoaded, word]);

        if (documentLoaded) {
          return React.createElement(
            "section",
            {className: "list-group-item", id, score, documentLoaded},
            [
              React.createElement(ResultHeader, {key: "result-header", word, documentLoaded})
              ,
              ...Object.entries(definitions).map(function ([key, value]) {
                return React.createElement(
                  "p",
                  {key: `result-definition-${key}`, className: "mb-1"},
                  `[${key}] ${value}`
                )
              }),
              React.createElement(ResultRoot, {key: "result-root", rootLoaded, ...rootResults}),
              React.createElement(ResultFooter, {key: "result-footer", id, score}),
            ]
          );
        }

        return null;
      };

      function Results ({rows}) {
        return React.createElement(
          "section",
          {key: "row-list", className: "list-group"},
          rows.map(({id, score}) => React.createElement(Result, {key: id, id, score}))
        );
      };

      function Search ({setQuery, query}) {
        return React.createElement(
          "form",
          {key: "search-form", className: "p-1"},
          React.createElement(
            "section",
            {className: "form-row"},
            React.createElement(
              "section",
              {className: "col input-group"},
              [
                React.createElement(
                  "section",
                  {key: "search-icon", className: "input-group-prepend"},
                  React.createElement(
                    "span",
                    {className: "input-group-text"},
                    "Search"
                  )
                ),
                React.createElement(
                  "input",
                  {key: "search-input", className: "form-control form-control-lg", type: "text", onChange: (event) => setQuery(event.target.value), value: query}
                )
              ]
            )
          )
        )
      }

      function Application () {
        const [{total_rows, rows, offset}, setResults] = React.useState({});
        const [query, setQuery] = React.useState(undefined)

        React.useEffect(function () {
          if (query && query.length > 2) {
            DATABASE
              .search({
                query,
                fields: [
                  "definitions.unknown",
                  "definitions.n",
                  "definitions.vt",
                  "definitions.vo",
                  "definitions.vs",
                  "definitions.vi",
                ]
              })
              .then(setResults);
          } else {
            setResults({})
          }
        }, [query]);

        if (rows) {
          return React.createElement(
            React.Fragment,
            {},
            [
              React.createElement(
                "section",
                {key: "search-message", className: "p-1"},
                [
                  "Searching for ",
                  React.createElement("em", {key: "search-message-query"}, query),
                  ` we have found ${total_rows} results.`
                ]
              ),
              React.createElement(Search, {key: "search", query, setQuery}),
              React.createElement(Results, {key: "results", total_rows, rows, offset}),
            ]
          );
        };

        if (query && query.length > 2) {
          return React.createElement(
            React.Fragment,
            {},
            [
              React.createElement("section", {key: "loading-message", className: "alert alert-light mb-0"}, "Searching... (first time will take a while)"),
              React.createElement(Search, {key: "search", query, setQuery}),
            ]
          );
        };

        return React.createElement(
          React.Fragment,
          {},
          [
            React.createElement("section", {key: "waiting-message", className: "alert alert-light mb-0"}, "Type below to search definitions."),
            React.createElement(Search, {key: "search", query, setQuery}),
          ]
        );
      };

      REPLICATION
        .on('change', function ({docs_written}) {
          ReactDOM.render(React.createElement("section", {className: "alert alert-light mb-0"}, `Importing ${docs_written} words...`), document.querySelector("main"))
        })
        .on('paused', function () {
          ReactDOM.render(React.createElement(Application, {}), document.querySelector("main"))
        });
    </script>
  </body>
</html>
