<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ba Kom</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script>

    </script>
  </head>

  <body>

    <main class="container-fluid">
      <section class="alert alert-light mb-0">
        Booting up...
      </section>
    </main>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pouchdb/7.0.0/pouchdb.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/pouchdb-adapter-memory@7.0.0/lib/index.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/pouchdb-quick-search@1.3.0/dist/pouchdb.quick-search.min.js" integrity="sha256-O2Fg8+71Ghtl5GSB/Z4ielEWXj46b163E3fcdFsc8lE=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ramda/0.25.0/ramda.min.js"></script>

    <script type="text/javascript">
      const localPouchDB = new PouchDB("indexdb");
      const remotePouchDB = new PouchDB("http://35.224.124.140:5984/dictionary");
      const localToRemoteReplication = localPouchDB
        .replicate
        .from(remotePouchDB, {live: true, retry: true, heartbeat: true, batch_size: 250});
      const LocalDatabaseContext = React.createContext(localPouchDB);
      const ReplicationContext = React.createContext(localToRemoteReplication);
      const ReplicationStateContext = React.createContext(undefined);

      function ResultHeader ({word, documentLoaded}) {
        return
      };

      function ResultAction ({setMode, mode}) {
        if (mode == "editing") {
          return React.createElement(
            "button",
            {type: "button", className: "btn btn-primary  btn-sm", onClick: () => setMode("saving")},
            "save"
          );
        };

        if (mode == "saving") {
          return React.createElement(
            "small",
            {className: "text-info"},
            "loading"
          );
        };

        if (mode == "errored") {
          return React.createElement(
            "small",
            {className: "text-danger"},
            "error"
          );
        };

        return React.createElement(
          "button",
          {type: "button", className: "btn btn-outline-dark  btn-sm", onClick: () => setMode("editing")},
          "edit"
        );
      };

      function ResultFooter ({id, score, setMode, mode}) {
        return React.createElement(
          "footer",
          {className: "mt-2 d-flex w-100 justify-content-between"},
          [
            React.createElement(ResultAction, {key: "result-footer-action", setMode, mode}),
            React.createElement(
              "small",
              {key: "result-footer-score", className: "text-muted"},
              score
            )
          ]
        );
      };

      function ResultRoot ({rootLoaded, resultCount, rows}) {
        if (rootLoaded) {
          return React.createElement(
            "section",
            {resultcount: resultCount, rootloaded: rootLoaded},
            rows.map(function ({id, highlighting: {word}}) {
              return React.createElement("li", {key: `result-root-${id}`, className: "badge badge-pill badge-light", dangerouslySetInnerHTML: {__html: word}, id})
            })
          );
        };

        return React.createElement(
          "section",
          {className: "alert alert-warning mb-0"},
          "Searching for root words..."
        );
      }

      function Result ({id, score}) {
        const localDatabaseContext = React.useContext(LocalDatabaseContext)
        const [edit, setEdit] = React.useState({})
        const [mode, setMode] = React.useState("viewing");
        const [documentLoaded, setDocumentLoaded] = React.useState(false);
        const [rootLoaded, setRootLoaded] = React.useState(false);
        const [{word, definitions, examples, note}, setDocumentResult] = React.useState({});
        const [rootResults, setRootResults] = React.useState({});

        React.useEffect(function () {
          if (mode == "saving") {
            localDatabaseContext
              .put(id, edit)
              .then(() => setDocumentLoaded(new Date()))
          }
        }, [mode]);

        React.useEffect(function () {
          localDatabaseContext
            .get(id)
            .then(setDocumentResult)
            .then(() => setDocumentLoaded(new Date()));
        }, [id, score]);

        React.useEffect(function () {
          if (word) {
            Promise.all(
              word
                .split(" / ")
                .flatMap((subsection) => subsection.split(" "))
                .map((subword) => localDatabaseContext.search({query: subword, fields: ["word"], highlighting: true, highlighting_pre: "<strong class=\"text-info\">"}))
            )
              .then(
                (results) =>
                  results.reduce(
                    (accumulation, result) =>
                      ({total_rows: accumulation.total_rows + result.total_rows, rows: [...accumulation.rows, ...result.rows]})
                  )
              )
              .then((results) => ({...results, rows: R.uniqBy(({id}) => id, results.rows)}))
              .then(setRootResults)
              .then(() => setRootLoaded(new Date()));
          }

        }, [documentLoaded, word]);

        if (documentLoaded && mode == "editing") {
          return React.createElement(
            "section",
            {className: "list-group-item", id, score, documentloaded: documentLoaded},
            [
              React.createElement(
                "form",
                {key: "result-form", className: "mb-1"},
                [
                  React.createElement(
                    "header",
                    {key: "result-form-header", className: "form-group"},
                    React.createElement(
                      "input",
                      {type: "text", className: "form-control form-control-lg", value: word, onChange: (event) => setEdit(R.mergeDeepRight(edit, {word: event.target.value}))}
                    )
                  ),
                  ...Object.entries(definitions).flatMap(function ([type, typeDefinitions]) {
                    return typeDefinitions.map(function (definition, index) {
                      return React.createElement(
                        "section",
                        {key: `result-form-definition-${type}-${index}`, className: "form-group"},
                        React.createElement(
                          "textarea",
                          {className: "form-control", value: definition, onChange: (event) => setEdit(R.mergeDeepRight(edit, {definitions: {[type]: [event.target.value]}}))}
                        )
                      )
                    })
                  })
                ]
              ),
              React.createElement(ResultFooter, {key: "result-footer", id, score, setMode, mode}),
            ]
          );
        }

        if (documentLoaded) {
          return React.createElement(
            "section",
            {className: "list-group-item", id, score, documentloaded: documentLoaded},
            [
              React.createElement(
                "header",
                {key: "result-header", className: "d-flex w-100 justify-content-between"},
                [
                  React.createElement(
                    "h5",
                    {key: "result-header-word", className: "mb-1"},
                    word
                  ),
                  React.createElement(
                    "small",
                    {key: "result-header-loaded", className: "text-muted"},
                    `Last fetched ${moment(documentLoaded).fromNow()}`
                  )
                ]
              ),
              ...Object.entries(definitions).flatMap(function ([type, typeDefinitions]) {
                return typeDefinitions.map(function (definition, index) {
                  return React.createElement(
                    "p",
                    {key: `result-definition-${type}-${index}`, className: "mb-1", type},
                    `[${type}] ${definition}`
                  )
                })
              }),
              React.createElement(ResultRoot, {key: "result-root", rootLoaded, ...rootResults}),
              React.createElement(ResultFooter, {key: "result-footer", id, score, setMode, mode}),
            ]
          );
        }

        return null;
      };

      function Results ({rows, resultCount, offset}) {
        if (rows) {
          return React.createElement(
            "section",
            {key: "row-list", className: "list-group"},
            rows.map(({id, score}) => React.createElement(Result, {key: id, id, score}))
          );
        }

        return null
      };

      function Search ({setQuery, query}) {
        const {pending: pendingDocumentCount} = React.useContext(ReplicationStateContext);

        return React.createElement(
          "form",
          {key: "search-form", className: "py-1"},
          React.createElement(
            "section",
            {className: "form-row"},
            React.createElement(
              "section",
              {className: "col input-group"},
              [
                React.createElement(
                  "section",
                  {key: "search-icon", className: "input-group-prepend"},
                  React.createElement(
                    "span",
                    {className: "input-group-text"},
                    "Search"
                  )
                ),
                React.createElement(
                  "input",
                  {
                    key: "search-input",
                    className: "form-control form-control-lg",
                    type: "text",
                    disabled: pendingDocumentCount > 0,
                    onChange: (event) => setQuery(event.target.value),
                    value: query,
                  }
                )
              ]
            )
          )
        )
      }

      function Metadata ({documentCount, query, resultCount, rows}) {
        const {start_time: replicationStateChangedAt, pending: pendingDocumentCount, last_seq} = React.useContext(ReplicationStateContext);

        if (pendingDocumentCount > 0) {
          return React.createElement(
            "section",
            {className: "alert alert-light mb-0"},
            [
              `Last replicated ${moment(replicationStateChangedAt).fromNow()}.`,
              React.createElement("br"),
              `Waiting to replicate ${pendingDocumentCount || 0} words, ${documentCount} words already stored.`,
              React.createElement("br"),
              "Replicating..."
            ]
          )
        }

        if (query && query.length > 1 && rows && rows.length > 0) {
          return React.createElement(
            "section",
            {className: "alert alert-light mb-0"},
            [
              `Last replicated at ${moment(replicationStateChangedAt).fromNow()}.`,
              React.createElement("br"),
              `${documentCount} total words in dictionary.`,
              React.createElement("br"),
              `Searching for "${query}", we have found ${resultCount} matches.`,
            ]
          )
        }

        if (query && query.length > 1) {
          return React.createElement(
            "section",
            {className: "alert alert-light mb-0"},
            [
              `Last replicated at ${moment(replicationStateChangedAt).fromNow()}.`,
              React.createElement("br"),
              `${documentCount} total words in dictionary.`,
              React.createElement("br"),
              `Searching for "${query}"... (first search is slow)`,
            ]
          )
        }

        return React.createElement(
          "section",
          {className: "alert alert-light mb-0"},
          [
            `Last replicated ${moment(replicationStateChangedAt).fromNow()}.`,
            React.createElement("br"),
            `${documentCount} total words in dictionary.`,
            React.createElement("br"),
            "Type above to start searching the dictionary.",
          ]
        )
      }

      function Application () {
        const localDatabaseContext = React.useContext(LocalDatabaseContext);
        const replicationContext = React.useContext(ReplicationContext);
        const replicationStateContext = React.useContext(ReplicationStateContext);
        const [documentCount, setDocumentCount] = React.useState(0);
        const [replicationState, setReplicationState] = React.useState(replicationContext);
        const [{total_rows: resultCount, rows, offset}, setResults] = React.useState({});
        const [query, setQuery] = React.useState(undefined);

        replicationContext.removeAllListeners("change")
        replicationContext.on("change", setReplicationState)

        React.useEffect(function () {
          localDatabaseContext.info().then(({doc_count}) => setDocumentCount(doc_count));
        }, [replicationState.last_seq]);

        React.useEffect(function () {
          if (query && query.length > 1) {
            localDatabaseContext
              .search({
                query,
                fields: [
                  "word",
                  "definitions.unknown",
                  "definitions.n",
                  "definitions.vt",
                  "definitions.vo",
                  "definitions.vs",
                  "definitions.vi",
                ]
              })
              .then(setResults);
          } else {
            setResults({})
          }
        }, [query]);

        return React.createElement(
          ReplicationStateContext.Provider,
          {value: replicationState},
          [
            React.createElement(Search, {key: "search", query, setQuery}),
            React.createElement(Results, {key: "results", resultCount, rows, offset}),
            React.createElement(Metadata, {key: "metadata", query, rows, documentCount, resultCount})
          ]
        );
      };

      ReactDOM.render(
        React.createElement(Application),
        document.querySelector("main")
      )
    </script>
  </body>
</html>
